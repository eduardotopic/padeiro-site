
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Pedido de Pães</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input, button, label, select { display: block; margin: 10px 0; width: 300px; }
    option[data-hoje="true"] { background-color: #dff0d8; font-weight: bold; }
  </style>
</head>
<body>
  <h2>Pedido de Pães</h2>
  <form id="pedidoForm">
    <label>Escolha o dia:</label>
    <select id="loteSelect"></select>

    <label>Nome:</label>
    <input type="text" id="nome" required />
    <label>Apartamento:</label>
    <input type="text" id="apto" required />
    <label>Torre:</label>
    <input type="text" id="torre" required />
    <label>Quantidade:</label>
    <input type="number" id="quantidade" min="1" max="10" required />
    <label>Comprovante (imagem ou PDF):</label>
    <input type="file" id="comprovante" accept="image/*,application/pdf" />
    <button type="submit" id="btnEnviar">Enviar Pedido</button>
  </form>

  <div id="status"></div>

  <script type="module">
    import {{ initializeApp }} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {{ getFirestore, collection, getDocs, query, orderBy, addDoc, Timestamp }} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import {{ getStorage, ref, uploadBytes, getDownloadURL }} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";
    import {{ getAuth, signInAnonymously }} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {{
      apiKey: "AIzaSyDlXbLRh3O6xqSDnU-If-z0lbfuYgLm8Rg",
      authDomain: "projeto-padeiro.firebaseapp.com",
      projectId: "projeto-padeiro",
      storageBucket: "projeto-padeiro.appspot.com",
      messagingSenderId: "905130125554",
      appId: "1:905130125554:web:225a7de84f2545043a086b"
    }};

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const auth = getAuth(app);

    signInAnonymously(auth).catch((error) => {{
      console.error("Erro login anônimo:", error.message);
    }});

    const loteSelect = document.getElementById("loteSelect");
    const hojeStr = new Date().toISOString().split('T')[0];
    let lotesMap = {{}};

    async function carregarLotes() {{
      const lotesRef = collection(db, "lotes");
      const snap = await getDocs(query(lotesRef, orderBy("data")));
      loteSelect.innerHTML = "";

      let selectedIndex = 0;
      let i = 0;
      snap.forEach((doc) => {{
        const lote = doc.data();
        const opt = document.createElement("option");
        opt.value = doc.id;
        opt.text = `${{lote.data}} - até ${{lote.limite}} pães`;
        if (lote.data === hojeStr) {{
          opt.text += " (HOJE)";
          opt.dataset.hoje = "true";
          selectedIndex = i;
        }}
        loteSelect.appendChild(opt);
        lotesMap[doc.id] = lote;
        i++;
      }});
      loteSelect.selectedIndex = selectedIndex;
    }}

    carregarLotes();

    document.getElementById("nome").value = localStorage.getItem("nome") || "";
    document.getElementById("apto").value = localStorage.getItem("apto") || "";
    document.getElementById("torre").value = localStorage.getItem("torre") || "";

    
    const btnEnviar = document.getElementById("btnEnviar");
    document.getElementById("pedidoForm").addEventListener("submit", async (e) => {
      btnEnviar.disabled = true;
      document.getElementById("status").innerText = "⏳ Enviando pedido...";
    {
      e.preventDefault();
      const nome = document.getElementById("nome").value;
      const apto = document.getElementById("apto").value;
      const torre = document.getElementById("torre").value;
      const quantidade = parseInt(document.getElementById("quantidade").value);
      const comprovante = document.getElementById("comprovante").files[0];
      const loteId = loteSelect.value;

      localStorage.setItem("nome", nome);
      localStorage.setItem("apto", apto);
      localStorage.setItem("torre", torre);

      const pedidosRef = collection(db, "pedidos");
      const snap = await getDocs(query(pedidosRef));
      let totalAtual = 0;
      snap.forEach((doc) => {{
        const p = doc.data();
        if (p.loteId === loteId) {{
          totalAtual += p.quantidade;
        }}
      }});

      const limite = lotesMap[loteId].limite;
      if (totalAtual + quantidade > limite) {{
        alert("Limite excedido para esse lote.");
        return;
      }}

      let url = "";
      if (comprovante) {{
        
      const nomeLimpo = comprovante.name.replace(/[^a-zA-Z0-9._-]/g, "_");
      const fileRef = ref(storage, `comprovantes/${Date.now()}_${nomeLimpo}`);
    
        await uploadBytes(fileRef, comprovante);
        url = await getDownloadURL(fileRef);
      }}

      await addDoc(pedidosRef, {{
        nome,
        apto,
        torre,
        quantidade,
        data: Timestamp.now(),
        comprovanteUrl: url,
        loteId: loteId,
        viaZap: false
      }});

      
      btnEnviar.disabled = false;
      document.getElementById("status").innerText = "✅ Pedido enviado com sucesso!";
    
      document.getElementById("pedidoForm").reset();
      carregarLotes();
    }});
  </script>
</body>
</html>
